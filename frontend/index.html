<!DOCTYPE html>
<html lang="fr">

<head>
    <title>B1 ou 21JET</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Ce site détermine à la station Métro Rond Point du Prado quel bus prendre entre le B1 et le 21JET pour arriver le plus tôt possible à Luminy.">
    <meta name="author" content="imgogole">
    <meta name="theme-color" content="#1d1d1d">
    <meta name="keywords" content="marseille, rtm, bus, B1, 21JET, Luminy, transport, métro">
    <link rel="icon" type="image/png" href="images/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="manifest" href="/manifest.json">
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            min-height: 100vh;
            background-color: #1d1d1d;
            color: #d3d3d3;
            font-family: 'Fira Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            padding-top: 40px;
            padding-bottom: 20px;
        }

        h1 {
            margin-bottom: 30px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 15px;
        }

        #image-container {
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        img {
            width: 200px;
            height: 200px;
        }

        select {
            width: 200px;
            padding: 10px 12px;
            background-color: #3c3c3c;
            color: #dddddd;
            border: none;
            border-radius: 8px;
            font-family: 'Fira Sans', sans-serif;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:focus {
            box-shadow: 0 0 5px #1db954;
            background-color: #3c3c3c;
        }


        .loading {
            width: 50px;
            height: 50px;
            border: 5px solid #444;
            border-top: 5px solid #1db954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            color: #ff4c4c;
            margin-top: 10px;
        }

        #description {
            margin-top: 30px;
            font-size: 85%;
            font-style: italic;
            color: #aaaaaa;
            text-align: center;
            padding: 0 65px;
        }

        #mention_honorable {
            margin-top: 10px;
            font-size: 75%;
            font-style: italic;
            color: #727272;
            text-align: center;
            padding: 0 65px;
        }


        a {
            color: #66ccff;
            font-weight: bold;
            text-decoration: none;
        }

        #last-update {
            margin-top: 10px;
            margin-bottom: 15px;
        }

        #flags-dropdown-custom {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .option {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background-color: #3c3c3c;
            color: #9f9f9f;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            text-align: center;
            width: 100%;
            height: 36px;
        }

        .option .tooltip {
            position: absolute;
            font-weight: normal;
            bottom: 120%;
            left: 0;
            width: 100%;
            background-color: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transform: translateY(5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: normal;
            box-sizing: border-box;
            z-index: 10;
        }

        .option:hover .tooltip {
            opacity: 1;
            transform: translateY(0);
        }


        .option .tooltip::before {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }


        .option.selected {
            font-weight: bold;
            color: #c8ffb9;
        }
    </style>
</head>

<body>
    <h1>B1 ou 21JET</h1>
    <div class="container">
        <div id="image-container">
            <div class="loading" id="loading"></div>
        </div>
        <div id="last-update"></div>
        <select id="enum-dropdown">
            <option value="0" selected>Règle des 7 minutes</option>
            <option value="1">Tête chercheuse</option>
        </select>
        <div id="flags-dropdown-custom">
            <!-- Tooltip
             Color : <span style="color:red">Texte rouge</span>
             Saut : <br>
            -->
            <div class="option" data-value="1" related="1">
                Écart maximum
                <div class="tooltip">
                    <span style="color:rgb(255, 113, 113)">Désactivé : </span> Les écarts théoriques moyens des stations intraquables seront pris en compte.
                    <br>
                    <span style="color:rgb(157, 255, 156)">Activé : </span> Les écarts théoriques maximaux des stations intraquables seront pris en compte.
                    <br>
                </div>
            </div>
            <div class="option" data-value="2" related="1">
                Théorème d'Obélisque
                <div class="tooltip">
                    <span style="color:rgb(157, 255, 156)">Activé : </span> Un ralentissement est appliqué à toutes les stations entre <b>Métro Rond Point du Prado</b> et <b>Obélisque</b>, le temps de parcours du B1 sera pénalisé.
                    <br>
                </div>
            </div>
        </div>
        <div class="error" id="error-message"></div>
        <div id="description">Ce site détermine à la station <b>Métro Rond Point du Prado</b> quel bus prendre entre le
            <b>B1</b> et le <b>21JET</b> pour arriver le plus tôt possible à <b>Luminy</b>.
            <br>
            Toutes les informations et le code source sur mon <a href="https://github.com/imgogole/b1-or-21jet"
                target="_blank">GitHub</a>. Merci <b>Elphlach</b> pour le repas du Crous à 1€.
        </div>
        <div id="mention_honorable">@imgogole</div>
    </div>

    <script>
        const imageContainer = document.getElementById('image-container');
        const loading = document.getElementById('loading');
        const enumDropdown = document.getElementById('enum-dropdown');
        const lastUpdate = document.getElementById('last-update');
        const errorMessage = document.getElementById('error-message');
        const flagsContainer = document.getElementById('flags-dropdown-custom');

        let selectedFlags = 0;

        function setFavicon(imgSrc) {
            let link = document.querySelector("link[rel~='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'icon';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
            link.href = imgSrc;
        }

        function updateFlagsVisibility() {
            const selected = enumDropdown.value;
            const options = flagsContainer.getElementsByClassName("option");

            Array.from(options).forEach(div => {
                const related = div.getAttribute('related');
                div.style.display = related === selected ? 'flex' : 'none';
                if (related !== selected) div.classList.remove('selected');
            });
        }


        flagsContainer.addEventListener('click', (e) => {
            if (!e.target.classList.contains('option')) return;

            const flagValue = parseInt(e.target.dataset.value);

            if (e.target.classList.contains('selected')) {
                e.target.classList.remove('selected');
                selectedFlags &= ~flagValue;
            } else {
                e.target.classList.add('selected');
                selectedFlags |= flagValue;
            }

            localStorage.setItem('lastSelection', JSON.stringify({
                enumValue: enumDropdown.value,
                flags: selectedFlags
            }));

            fetchData();
        });

        const fetchData = () => {
            updateFlagsVisibility();
            setFavicon('images/logo.png');

            loading.style.display = 'block';
            imageContainer.innerHTML = '';
            imageContainer.appendChild(loading);
            errorMessage.textContent = '';

            const enumValue = parseInt(enumDropdown.value);
            const flags = selectedFlags;

            const url = window.location.hostname.includes("localhost") ? `http://localhost:5000/api/${enumValue}/${flags}` : `https://b1-or-21jet-backend.onrender.com/api/${enumValue}/${flags}`;


            fetch(url, {
                method: "get",
                headers: new Headers({
                    "ngrok-skip-browser-warning": "69420",
                }),
            })
                .then(response => {
                    console.log(response);
                    if (!response.ok) throw new Error('Erreur réseau');
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    if (data.status !== 'success') {
                        throw new Error('Erreur dans la réponse');
                    }
                    if (data['21jet_prob'] === 0 && data['b1_prob'] === 0) {
                        imageContainer.textContent = "Pas de bus disponible";
                        setFavicon('images/logo.png');
                    } else if (data['21jet_prob'] > data['b1_prob']) {
                        const img = document.createElement('img');
                        img.src = 'images/21jet_logo.svg';
                        setFavicon('images/21jet_logo.svg');
                        imageContainer.appendChild(img);
                    } else {
                        const img = document.createElement('img');
                        img.src = 'images/b1_logo.svg';
                        setFavicon('images/b1_logo.svg');
                        imageContainer.appendChild(img);
                    }

                    const date = new Date(data.time * 1000);
                    lastUpdate.innerHTML = `Dernière mise à jour : <b>${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}</b>`;
                })
                .catch(err => {
                    loading.style.display = 'none';
                    imageContainer.textContent = '';
                    errorMessage.textContent = `Erreur: ${err.message}`;
                });
        };

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('lastSelection');
            if (saved) {
                const { enumValue, flags } = JSON.parse(saved);
                enumDropdown.value = enumValue;
                selectedFlags = flags;

                const options = flagsContainer.getElementsByClassName('option');
                Array.from(options).forEach(div => {
                    const flagValue = parseInt(div.dataset.value);
                    if ((flags & flagValue) !== 0) {
                        div.classList.add('selected');
                    } else {
                        div.classList.remove('selected');
                    }
                });
            }

            fetchData();
        });

        enumDropdown.addEventListener('change', () => {
            localStorage.setItem('lastSelection', JSON.stringify({
                enumValue: enumDropdown.value,
                flags: selectedFlags
            }));
            fetchData();
        });
    </script>

</body>

</html>